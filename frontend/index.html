<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Healthcare Memory Assistant</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --bg-input: #f1f5f9;
            --accent: #10b981;
            --accent-secondary: #14b8a6;
            --accent-glow: rgba(16, 185, 129, 0.2);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --border-hover: #cbd5e1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 1rem;
            transition: color 0.2s;
        }

        .back-link:hover {
            color: var(--accent);
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem 0;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-secondary), var(--accent));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        /* Patient Summary Card */
        .patient-summary-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .patient-avatar {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .patient-info h3 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
            color: var(--text-primary);
        }

        .patient-details {
            display: flex;
            gap: 0.75rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .patient-details span {
            position: relative;
        }

        .patient-details span:not(:last-child)::after {
            content: "‚Ä¢";
            position: absolute;
            right: -0.5rem;
            color: var(--border);
        }

        .patient-meta {
            margin-left: auto;
            display: flex;
            gap: 2rem;
        }

        .meta-item {
            display: flex;
            flex-direction: column;
        }

        .meta-item .label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }

        .meta-item .value {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        @media (max-width: 768px) {
            .patient-meta {
                width: 100%;
                margin-left: 0;
                justify-content: space-between;
                border-top: 1px solid var(--border);
                padding-top: 1rem;
            }
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--bg-card);
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            margin-top: 1rem;
            font-size: 0.875rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: var(--bg-secondary);
            padding: 0.5rem;
            border-radius: 1rem;
            width: fit-content;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 0.75rem;
            transition: all 0.3s ease;
        }

        .tab:hover {
            color: var(--text-primary);
        }

        .tab.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 4px 15px var(--accent-glow);
        }

        /* Panels */
        .panel {
            display: none;
        }

        .panel.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .card h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 0.875rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: inherit;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 0.75rem;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-secondary), var(--accent));
            color: white;
            box-shadow: 0 4px 15px var(--accent-glow);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--accent-glow);
        }

        .btn-secondary {
            background: var(--bg-input);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-card);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Response area */
        .response-area {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-top: 1.5rem;
            min-height: 200px;
        }

        .response-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .response-meta {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .meta-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.35rem 0.75rem;
            background: var(--bg-card);
            border-radius: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .meta-badge.success {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .meta-badge.warning {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .answer-text {
            font-size: 1rem;
            line-height: 1.8;
            color: var(--text-primary);
        }

        /* Formatted answer content */
        .answer-content {
            font-size: 1rem;
            line-height: 1.8;
            color: var(--text-primary);
        }

        .answer-content p {
            margin-bottom: 1rem;
        }

        .answer-content .section-header {
            font-size: 1.05rem;
            font-weight: 600;
            color: var(--accent);
            margin: 1.5rem 0 0.75rem 0;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .answer-content .section-header:first-child {
            margin-top: 0;
        }

        .answer-content .symptom-list {
            list-style: none;
            padding: 0;
            margin: 0.75rem 0;
        }

        .answer-content .symptom-list li {
            position: relative;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            background: var(--bg-card);
            border-radius: 0.5rem;
            border-left: 3px solid var(--accent);
            transition: all 0.2s ease;
        }

        .answer-content .symptom-list li:hover {
            background: rgba(99, 102, 241, 0.1);
            transform: translateX(4px);
        }

        .answer-content .list-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: var(--accent);
            color: white;
            border-radius: 50%;
            font-size: 0.75rem;
            font-weight: 700;
            margin-right: 0.75rem;
        }

        .answer-content strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        .answer-content em {
            color: var(--text-secondary);
            font-style: italic;
        }

        .answer-content .quoted-term {
            color: var(--warning);
            font-style: italic;
        }

        .disclaimer {
            margin-top: 1.5rem;
            padding: 1rem;
            background: rgba(99, 102, 241, 0.1);
            border-left: 3px solid var(--accent);
            border-radius: 0 0.5rem 0.5rem 0;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Evidence list */
        .evidence-list {
            margin-top: 1rem;
        }

        .evidence-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            transition: border-color 0.3s;
        }

        .evidence-item:hover {
            border-color: var(--accent);
        }

        .evidence-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .evidence-type {
            padding: 0.25rem 0.75rem;
            background: var(--accent);
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .evidence-score {
            color: var(--success);
            font-weight: 600;
        }

        .evidence-content {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Stats grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.25rem;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 2rem;
            color: var(--text-muted);
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Quick actions */
        .quick-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .quick-btn {
            padding: 0.5rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 2rem;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quick-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            border-color: var(--success);
        }

        .toast.error {
            border-color: var(--danger);
        }

        /* Smart Suggestions */
        .patient-input-group {
            display: flex;
            gap: 0.5rem;
        }

        .patient-input-group input {
            flex: 1;
        }

        .btn-icon {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.3s;
        }

        .btn-icon:hover {
            background: var(--accent);
            border-color: var(--accent);
        }

        .smart-suggestions {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.05));
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 1rem;
            padding: 1rem;
            margin-bottom: 1.25rem;
        }

        .suggestion-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .suggestion-icon {
            font-size: 1.2rem;
        }

        .suggestion-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .patient-badge {
            margin-left: auto;
            padding: 0.25rem 0.75rem;
            background: var(--bg-card);
            border-radius: 2rem;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .patient-badge.has-data {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .patient-badge.no-data {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .suggestion-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .suggestion-tag {
            padding: 0.5rem 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 2rem;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }

        .suggestion-tag:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .suggestion-tag .tag-icon {
            font-size: 0.9rem;
        }

        .loading-dots {
            color: var(--text-muted);
            font-size: 0.85rem;
            animation: blink 1.5s infinite;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .no-suggestions {
            color: var(--text-muted);
            font-size: 0.85rem;
            font-style: italic;
        }

        /* Timeline Styles */
        .timeline-container {
            position: relative;
            padding: 1rem 0;
        }

        .timeline-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: var(--bg-card);
            border-radius: 1rem;
            border: 1px solid var(--border);
        }

        .timeline-header h4 {
            font-size: 1.1rem;
            margin: 0;
        }

        .timeline-stats {
            display: flex;
            gap: 1.5rem;
        }

        .timeline-stat {
            text-align: center;
        }

        .timeline-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
        }

        .timeline-stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .timeline {
            position: relative;
            padding-left: 2rem;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 0.5rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, var(--accent), var(--accent-secondary));
            border-radius: 1px;
        }

        .timeline-item {
            position: relative;
            padding: 1rem 1.25rem;
            margin-bottom: 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            transition: all 0.3s ease;
        }

        .timeline-item:hover {
            border-color: var(--accent);
            transform: translateX(4px);
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -1.75rem;
            top: 1.25rem;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent);
            border: 2px solid var(--bg-primary);
        }

        .timeline-item.mental_health::before {
            background: #8b5cf6;
        }

        .timeline-item.medication::before {
            background: #10b981;
        }

        .timeline-item.clinical::before {
            background: #3b82f6;
        }

        .timeline-item.note::before {
            background: #f59e0b;
        }

        .timeline-item-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .timeline-type-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 2rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .timeline-type-badge.mental_health {
            background: rgba(139, 92, 246, 0.2);
            color: #8b5cf6;
        }

        .timeline-type-badge.medication {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .timeline-type-badge.clinical {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .timeline-type-badge.note {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .timeline-source {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .timeline-date {
            margin-left: auto;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .timeline-content {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .timeline-content strong {
            color: var(--text-primary);
        }

        .timeline-empty {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }
    </style>
</head>

<body>
    <div class="container">
        <a href="landing.html" class="back-link">
            <span>‚Üê</span> Back to Home
        </a>

        <header class="header">
            <h1>üß† Healthcare Memory Assistant</h1>
            <p>Evidence-grounded, hallucination-free patient memory system</p>
            <div class="status-badge">
                <span class="status-dot"></span>
                <span id="healthStatus">Checking connection...</span>
            </div>
        </header>

        <!-- Patient Summary Card (Default Hidden) -->
        <div class="patient-summary-card" id="patientSummaryCard" style="display: none;">
            <div class="patient-avatar">RV</div>
            <div class="patient-info">
                <h3>Rahul Verma</h3>
                <div class="patient-details">
                    <span>Male</span>
                    <span>20‚Äì25</span>
                    <span>College Student</span>
                </div>
            </div>
            <div class="patient-meta">
                <div class="meta-item">
                    <span class="label">Patient ID</span>
                    <span class="value">patient_001</span>
                </div>
                <div class="meta-item">
                    <span class="label">Department</span>
                    <span class="value">Mental Health</span>
                </div>
                <div class="meta-item">
                    <span class="label">First Visit</span>
                    <span class="value">Jan 2024</span>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="search">üîç Search</button>
            <button class="tab" data-tab="timeline">üìÖ Timeline</button>
            <button class="tab" data-tab="ingest">‚ûï Add Memory</button>
            <button class="tab" data-tab="summary">üìã Summary</button>
            <button class="tab" data-tab="demo">üéØ Demo</button>
            <button class="tab" data-tab="guide">üìö Guide</button>
        </div>

        <!-- Search Panel -->
        <div id="search" class="panel active">
            <div class="card">
                <h3>üîç Ask a Question</h3>
                <div class="form-group">
                    <label>Patient ID</label>
                    <div class="patient-input-group">
                        <input type="text" id="searchPatientId" value="patient_001" placeholder="patient_001"
                            oninput="debounce(loadPatientSuggestions, 600)()">
                        <button class="btn-icon" onclick="loadPatientSuggestions()"
                            title="Load patient data">üîÑ</button>
                    </div>
                </div>

                <!-- Smart Suggestions -->
                <div id="smartSuggestions" class="smart-suggestions">
                    <div class="suggestion-header">
                        <span class="suggestion-icon">üí°</span>
                        <span class="suggestion-title">Smart Suggestions</span>
                        <span id="patientBadge" class="patient-badge">Loading...</span>
                    </div>
                    <div id="suggestionTags" class="suggestion-tags">
                        <span class="loading-dots">Analyzing patient data...</span>
                    </div>
                </div>

                <div class="form-group">
                    <label>Your Question</label>
                    <input type="text" id="searchQuery" placeholder="What symptoms did the patient report?">
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="search()">
                        <span>üîç Get Grounded Answer</span>
                    </button>
                    <button class="btn btn-secondary" onclick="clearSearch()">
                        Clear
                    </button>
                </div>
            </div>

            <div id="searchResponse" class="response-area" style="display: none;"></div>
        </div>

        <!-- Timeline Panel -->
        <div id="timeline" class="panel">
            <div class="card">
                <h3>üìÖ Patient Memory Timeline</h3>
                <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                    View chronological history of patient records and treatment progress.
                </p>
                <div class="form-group">
                    <label>Patient ID</label>
                    <div class="patient-input-group">
                        <input type="text" id="timelinePatientId" value="patient_demo_1" placeholder="patient_demo_1">
                        <button class="btn-icon" onclick="loadTimeline()" title="Load timeline">üìÖ</button>
                    </div>
                </div>
                <div class="quick-actions" style="margin-bottom: 1rem;">
                    <span style="color: var(--text-muted); font-size: 0.8rem;">Demo patients:</span>
                    <button class="quick-btn"
                        onclick="document.getElementById('timelinePatientId').value='patient_demo_1';loadTimeline()">Demo
                        1: Anxiety</button>
                    <button class="quick-btn"
                        onclick="document.getElementById('timelinePatientId').value='patient_demo_2';loadTimeline()">Demo
                        2: Medication</button>
                    <button class="quick-btn"
                        onclick="document.getElementById('timelinePatientId').value='patient_demo_3';loadTimeline()">Demo
                        3: Student</button>
                </div>
                <button class="btn btn-primary" onclick="loadTimeline()">
                    <span>üìÖ Load Timeline</span>
                </button>
            </div>

            <div id="timelineContainer" class="timeline-container" style="display: none;"></div>
        </div>

        <!-- Ingest Panel -->
        <div id="ingest" class="panel">
            <div class="card">
                <h3>‚ûï Add Patient Memory</h3>
                <div class="form-group">
                    <label>Patient ID</label>
                    <input type="text" id="ingestPatientId" value="patient_001">
                </div>
                <div class="row">
                    <div class="form-group">
                        <label>Memory Type</label>
                        <select id="ingestType">
                            <option value="mental_health">Mental Health</option>
                            <option value="medication">Medication</option>
                            <option value="clinical">Clinical</option>
                            <option value="note">Note</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Source</label>
                        <select id="ingestSource">
                            <option value="session">Session</option>
                            <option value="doctor">Doctor</option>
                            <option value="import">Import</option>
                        </select>
                    </div>
                    <div class="row-3">
                        <div class="form-group">
                            <label>Visit Date</label>
                            <input type="date" id="ingestDate">
                        </div>
                        <div class="form-group">
                            <label>Visit Type</label>
                            <select id="ingestVisitType">
                                <option value="Follow-up">Follow-up</option>
                                <option value="Initial Consultation">Initial Consultation</option>
                                <option value="Emergency">Emergency</option>
                                <option value="Therapy Session">Therapy Session</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Clinician Role</label>
                            <select id="ingestClinician">
                                <option value="Counselor">Counselor</option>
                                <option value="Psychiatrist">Psychiatrist</option>
                                <option value="General Practitioner">General Practitioner</option>
                                <option value="Nurse">Nurse</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Memory Content</label>
                        <textarea id="ingestText" placeholder="Patient reports feeling anxious..."></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="ingestMemory()"
                        style="width: fit-content; padding: 0.6rem 1.5rem; font-size: 0.9rem; margin-top: 1rem; box-shadow: 0 4px 15px var(--accent-glow); border-radius: 0.25rem;">
                        <span>Save Memory</span>
                    </button>
                </div>

                <div id="ingestResponse" class="response-area" style="display: none;"></div>
            </div>
        </div>

        <!-- Summary Panel -->
        <div id="summary" class="panel">
            <div class="card">
                <h3>üìã Patient Summary</h3>
                <div class="form-group">
                    <label>Patient ID</label>
                    <input type="text" id="summaryPatientId" value="patient_001">
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-primary" onclick="getSummary()">Generate Summary</button>
                    <button class="btn btn-secondary" onclick="getStats()">View Stats</button>
                </div>
            </div>

            <div id="statsGrid" class="stats-grid" style="display: none;"></div>
            <div id="summaryResponse" class="response-area" style="display: none;"></div>
        </div>

        <!-- Demo Panel -->
        <div id="demo" class="panel">
            <div class="card">
                <h3>üéØ Anti-Hallucination Demo</h3>
                <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                    This demo shows how the system refuses to answer questions when no evidence exists.
                </p>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="card" style="margin: 0; background: var(--bg-secondary);">
                        <h4 style="color: var(--success); margin-bottom: 1rem;">‚úÖ Has Evidence</h4>
                        <button class="btn btn-secondary" style="width: 100%; margin-bottom: 0.5rem;"
                            onclick="demoQuery('anxiety symptoms racing thoughts', 'demoResult1')">
                            "Anxiety symptoms"
                        </button>
                        <div id="demoResult1" class="demo-result"></div>
                    </div>

                    <div class="card" style="margin: 0; background: var(--bg-secondary);">
                        <h4 style="color: var(--danger); margin-bottom: 1rem;">‚ùå No Evidence</h4>
                        <button class="btn btn-secondary" style="width: 100%; margin-bottom: 0.5rem;"
                            onclick="demoQuery('blood pressure heart rate', 'demoResult2')">
                            "Blood pressure"
                        </button>
                        <div id="demoResult2" class="demo-result"></div>
                    </div>
                </div>

                <div class="disclaimer" style="margin-top: 1.5rem;">
                    <strong>Key Insight:</strong> When no evidence is found, the LLM is <em>never called</em>.
                    The system returns a fixed "Insufficient data" response, guaranteeing zero hallucination.
                </div>
            </div>
        </div>
    </div>

    <!-- Guide Panel -->
    <div id="guide" class="panel">
        <div class="card">
            <h3>üìö User Guide: Creating High-Quality Patient Records</h3>
            <p style="color: var(--text-secondary); margin-bottom: 2rem;">
                Using structured data makes the AI significantly smarter during retrieval. Follow this guide to
                ensure hospital-grade data quality.
            </p>

            <div class="guide-section" style="margin-bottom: 2rem;">
                <h4
                    style="color: var(--accent); margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                    1. Patient Identification</h4>
                <div class="guide-item" style="margin-bottom: 1rem;">
                    <strong>Patient ID</strong>
                    <p style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.25rem;">
                        Unique identifier linking to the patient's file. Always use a consistent ID for the same
                        person.<br>
                        <em>Example: <code>patient_001</code> (Rahul Verma)</em>
                    </p>
                </div>
            </div>

            <div class="guide-section" style="margin-bottom: 2rem;">
                <h4
                    style="color: var(--accent); margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                    2. Data Origins (Source vs. Role)</h4>

                <div class="guide-item" style="margin-bottom: 1.5rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <div>
                            <strong
                                style="color: var(--text-primary); border-bottom: 2px solid #3b82f6; padding-bottom: 2px;">
                                üìç Source (Where?)
                            </strong>
                            <p style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                Describes the <strong>origin channel</strong> of the information.
                            </p>
                            <ul
                                style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.5rem; padding-left: 1rem;">
                                <li style="margin-bottom: 0.25rem;"><strong>Session:</strong> Direct patient interaction
                                    (Real-time).</li>
                                <li style="margin-bottom: 0.25rem;"><strong>Doctor:</strong> Clinical notes/referrals
                                    from a provider.</li>
                                <li style="margin-bottom: 0.25rem;"><strong>Import:</strong> Bulk data from external EMR
                                    systems.</li>
                            </ul>
                        </div>
                        <div>
                            <strong
                                style="color: var(--text-primary); border-bottom: 2px solid #10b981; padding-bottom: 2px;">
                                üë®‚Äç‚öïÔ∏è Clinician Role (Who?)
                            </strong>
                            <p style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                Describes the <strong>author's qualification</strong>.
                            </p>
                            <ul
                                style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.5rem; padding-left: 1rem;">
                                <li style="margin-bottom: 0.25rem;"><strong>Psychiatrist:</strong> MD, handles meds &
                                    diagnosis.</li>
                                <li style="margin-bottom: 0.25rem;"><strong>Counselor:</strong> PhD/MA, handles therapy
                                    & talk.</li>
                                <li style="margin-bottom: 0.25rem;"><strong>Nurse/GP:</strong> Handles vitals & general
                                    care.</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="guide-item" style="background: var(--bg-secondary); padding: 1rem; border-radius: 0.75rem;">
                    <strong>üí° Common Combinations</strong>
                    <table style="width: 100%; margin-top: 0.75rem; font-size: 0.85rem; border-collapse: collapse;">
                        <tr style="border-bottom: 1px solid var(--border);">
                            <th style="text-align: left; padding: 0.5rem; color: var(--text-secondary);">Source</th>
                            <th style="text-align: left; padding: 0.5rem; color: var(--text-secondary);">Role</th>
                            <th style="text-align: left; padding: 0.5rem; color: var(--text-secondary);">Use Case</th>
                        </tr>
                        <tr>
                            <td style="padding: 0.5rem;">Session</td>
                            <td style="padding: 0.5rem;">Counselor</td>
                            <td style="padding: 0.5rem;">Therapy notes, patient feelings.</td>
                        </tr>
                        <tr>
                            <td style="padding: 0.5rem;">Doctor</td>
                            <td style="padding: 0.5rem;">Psychiatrist</td>
                            <td style="padding: 0.5rem;">Diagnosis, medication changes.</td>
                        </tr>
                        <tr>
                            <td style="padding: 0.5rem;">Doctor</td>
                            <td style="padding: 0.5rem;">Nurse</td>
                            <td style="padding: 0.5rem;">Routine vitals checkup.</td>
                        </tr>
                    </table>
                </div>
            </div>

            <div class="guide-section" style="margin-bottom: 2rem;">
                <h4
                    style="color: var(--accent); margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                    3. Categorization</h4>
                <div class="guide-item">
                    <strong>Memory Type</strong>
                    <p style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.25rem;">
                        Categorizes the information for specific retrieval contexts.
                    </p>
                    <div
                        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; margin-top: 0.75rem;">
                        <div style="background: var(--bg-primary); padding: 0.75rem; border-radius: 0.5rem;">
                            <strong style="color: #8b5cf6;">Mental Health</strong>
                            <p style="font-size: 0.8rem; margin-top: 0.25rem;">Moods, anxiety, depression symptoms,
                                triggers.</p>
                        </div>
                        <div style="background: var(--bg-primary); padding: 0.75rem; border-radius: 0.5rem;">
                            <strong style="color: #10b981;">Medication</strong>
                            <p style="font-size: 0.8rem; margin-top: 0.25rem;">Prescriptions, side effects, dosage
                                changes, adherence.</p>
                        </div>
                        <div style="background: var(--bg-primary); padding: 0.75rem; border-radius: 0.5rem;">
                            <strong style="color: #3b82f6;">Clinical</strong>
                            <p style="font-size: 0.8rem; margin-top: 0.25rem;">Physical stats (BP, Weight), lab
                                results, diagnoses.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="guide-section">
                <h4
                    style="color: var(--accent); margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">
                    4. Content Best Practices</h4>
                <p style="font-size: 0.95rem; color: var(--text-primary); margin-bottom: 1rem;">
                    The <strong>Memory Content</strong> is what the AI actually "reads". Be descriptive and
                    specific. Natural language is preferred over bullet points.
                </p>

                <div
                    style="background: rgba(16, 185, 129, 0.1); border: 1px solid var(--success); border-radius: 0.75rem; padding: 1rem;">
                    <strong style="color: var(--success); display: block; margin-bottom: 0.5rem;">‚úÖ Perfect
                        &quot;Mental Health&quot; Entry Example:</strong>
                    <p style="font-family: monospace; font-size: 0.9rem; color: var(--text-primary);">
                        "Patient is a 24-year-old male student reporting persistent anxiety for 3 months. Reports
                        'tightness in chest' and difficulty concentrating on studies. Sleep is disrupted; wakes up
                        at 3 AM and cannot return to sleep. Denies suicidal ideation."
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // Configuration
        const CONFIG = {
            API_LOCAL: 'http://localhost:8000/api/v1',
            API_PROD: 'https://healthcare-memory-assistant.onrender.com/api/v1'
        };

        // Determine API URL based on hostname
        const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const API_BASE = isLocal ? CONFIG.API_LOCAL : CONFIG.API_PROD;

        // Utility: Debounce
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });

        // Health check
        async function checkHealth() {
            try {
                const res = await fetch(`${API_BASE}/health`);
                const data = await res.json();
                const status = document.getElementById('healthStatus');
                if (data.status === 'healthy') {
                    status.textContent = `Connected ‚Ä¢ Qdrant ${data.qdrant}`;
                } else {
                    status.textContent = 'Degraded';
                }
            } catch (e) {
                document.getElementById('healthStatus').textContent = 'Disconnected';
            }
        }
        checkHealth();

        // =============================================
        // SMART SUGGESTIONS
        // =============================================

        // Load suggestions when page loads
        setTimeout(() => loadPatientSuggestions(), 500);

        // Load patient suggestions
        async function loadPatientSuggestions() {
            const patientId = document.getElementById('searchPatientId').value;
            const suggestionsDiv = document.getElementById('suggestionTags');
            const badge = document.getElementById('patientBadge');

            suggestionsDiv.innerHTML = '<span class="loading-dots">Analyzing patient records...</span>';
            badge.textContent = "Analyzing...";
            badge.className = 'patient-badge';

            try {
                // Fetch dynamic suggestions
                const res = await fetch(`${API_BASE}/patient/${patientId}/suggestions`);
                if (!res.ok) throw new Error("Failed to load suggestions");

                const data = await res.json();

                if (data.suggestions && data.suggestions.length > 0) {
                    // Map simple strings to object structure
                    const suggestionObjs = data.suggestions.map(s => ({
                        text: s.length > 40 ? s.substring(0, 37) + '...' : s,
                        query: s,
                        icon: 'üí°'
                    }));
                    renderSuggestions(suggestionsDiv, suggestionObjs);

                    badge.classList.add('access-granted');
                    badge.textContent = `Analyzed ${data.based_on_count} records`;
                } else {
                    suggestionsDiv.innerHTML = '<span class="tag">No specific suggestions found.</span>';
                    badge.textContent = "No Data";
                }

            } catch (e) {
                console.error("Suggestion Error:", e);
                // Fallback suggestions
                const fallbacks = [
                    { icon: 'üß†', text: 'Psychological Symptoms', query: 'What are the reported psychological symptoms?' },
                    { icon: 'üíä', text: 'Medication Review', query: 'List current medications and side effects.' },
                    { icon: 'üìä', text: 'Treatment Progress', query: 'Summarize treatment progress over the last month.' }
                ];
                renderSuggestions(suggestionsDiv, fallbacks);
                badge.classList.add('access-denied');
                badge.textContent = 'Offline Mode';
            }
        }

        function renderSuggestions(container, suggestions) {
            container.innerHTML = suggestions.map(s => `
                <button class="suggestion-tag" onclick="setQuery('${s.query.replace(/'/g, "\\'")}')">
                    <span class="tag-icon">${s.icon}</span>
                    ${s.text}
                </button>
            `).join('');
        }

        function setQuery(text) {
            const input = document.getElementById('searchQuery');
            input.value = text;
            input.focus();
        }

        // Clear search
        function clearSearch() {
            document.getElementById('searchQuery').value = '';
            document.getElementById('searchResponse').style.display = 'none';
        }

        // =============================================
        // TIMELINE FUNCTIONS
        // =============================================

        async function loadTimeline() {
            const patientId = document.getElementById('timelinePatientId').value;
            const container = document.getElementById('timelineContainer');

            container.style.display = 'block';
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading timeline...</div>';

            try {
                // Get patient stats
                const statsRes = await fetch(`${API_BASE}/patient/${patientId}/stats`);
                const stats = await statsRes.json();

                // Get search to retrieve memories (using a broad query)
                const searchRes = await fetch(`${API_BASE}/search`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        patient_id: patientId,
                        query: 'patient history symptoms treatment',
                        limit: 50
                    })
                });
                const searchData = await searchRes.json();

                if (stats.total_memories === 0) {
                    container.innerHTML = `
                        <div class="timeline-empty">
                            <p>üì≠ No records found for ${patientId}</p>
                            <p style="font-size: 0.9rem;">Try loading demo data or add memories first.</p>
                        </div>
                    `;
                    return;
                }

                renderTimeline(container, patientId, stats, searchData.evidence || []);

            } catch (e) {
                container.innerHTML = `<div class="timeline-empty">Error loading timeline: ${e.message}</div>`;
            }
        }

        function renderTimeline(container, patientId, stats, memories) {
            const typeIcons = {
                mental_health: 'üß†',
                medication: 'üíä',
                clinical: 'üè•',
                note: 'üìù'
            };

            const sortedMemories = memories.sort((a, b) =>
                new Date(b.created_at || 0) - new Date(a.created_at || 0)
            );

            let html = `
                <div class="timeline-header">
                    <h4>üìã ${patientId}</h4>
                    <div class="timeline-stats">
                        <div class="timeline-stat">
                            <div class="timeline-stat-value">${stats.total_memories}</div>
                            <div class="timeline-stat-label">Total Records</div>
                        </div>
                        ${Object.entries(stats.by_type || {}).map(([type, count]) => `
                            <div class="timeline-stat">
                                <div class="timeline-stat-value">${count}</div>
                                <div class="timeline-stat-label">${typeIcons[type] || 'üìÑ'} ${type.replace('_', ' ')}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="timeline">
            `;

            if (sortedMemories.length === 0) {
                html += `<div class="timeline-empty">No detailed records retrieved. Try using the Search tab for specific queries.</div>`;
            } else {
                sortedMemories.forEach((memory, index) => {
                    const type = memory.memory_type || 'note';
                    const source = memory.source || 'unknown';
                    const date = memory.created_at ? new Date(memory.created_at).toLocaleDateString() : 'Recent';
                    const content = memory.content || '';

                    // Get first line as title
                    const lines = content.split('\n').filter(l => l.trim());
                    const title = lines[0]?.substring(0, 60) + (lines[0]?.length > 60 ? '...' : '') || 'Memory Record';
                    const preview = lines.slice(1, 3).join(' ').substring(0, 200);

                    html += `
                        <div class="timeline-item ${type}">
                            <div class="timeline-item-header">
                                <span class="timeline-type-badge ${type}">${typeIcons[type] || 'üìÑ'} ${type.replace('_', ' ')}</span>
                                <span class="timeline-source">via ${source}</span>
                                <span class="timeline-date">${date}</span>
                            </div>
                            <div class="timeline-content">
                                <strong>${title}</strong>
                                ${preview ? `<p style="margin-top: 0.5rem; font-size: 0.85rem;">${preview}...</p>` : ''}
                            </div>
                        </div>
                    `;
                });
            }

            html += '</div>';
            container.innerHTML = html;
        }

        // Set query helper
        function setQuery(q) {
            document.getElementById('searchQuery').value = q;
        }

        // Search
        async function search() {
            const patientId = document.getElementById('searchPatientId').value;
            const query = document.getElementById('searchQuery').value;

            if (!query) {
                showToast('Please enter a question', 'error');
                return;
            }

            const responseDiv = document.getElementById('searchResponse');
            responseDiv.style.display = 'block';
            responseDiv.innerHTML = '<div class="loading"><div class="spinner"></div>Searching...</div>';

            try {
                const res = await fetch(`${API_BASE}/search/context`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ patient_id: patientId, query })
                });
                const data = await res.json();

                responseDiv.innerHTML = renderAnswer(data);
            } catch (e) {
                responseDiv.innerHTML = `<div class="empty-state">Error: ${e.message}</div>`;
            }
        }

        // Render answer with proper formatting
        function renderAnswer(data) {
            const hasContext = data.has_context;
            return `
                <div class="response-header">
                    <div class="response-meta">
                        <span class="meta-badge ${hasContext ? 'success' : 'warning'}">
                            ${hasContext ? '‚úì Evidence Found' : '‚úó No Evidence'}
                        </span>
                        <span class="meta-badge">üìö ${data.evidence_count} sources</span>
                        ${data.sources_used?.length ? `<span class="meta-badge">üè∑Ô∏è ${data.sources_used.join(', ')}</span>` : ''}
                    </div>
                </div>
                <div class="answer-text">${data.answer_text}</div>
                ${data.disclaimer && data.disclaimer !== 'No patient records matched this query.' ? `
                    <div class="disclaimer">${data.disclaimer.replace('---', '').trim()}</div>
                ` : ''}
            `;
        }

        // Format answer text with proper structure
        function formatAnswerText(text) {
            if (!text) return '';

            // First, try to normalize the text by adding newlines before patterns
            // This helps when LLM returns text without proper line breaks
            let normalized = text
                // Add newline before section headers (word(s) followed by :)
                .replace(/([.!?])\s*([A-Z][a-zA-Z\s&]+:)/g, '$1\n\n$2')
                // Add newline after section headers
                .replace(/([A-Z][a-zA-Z\s&]+:)\s*/g, '$1\n')
                // Add newline before numbered items
                .replace(/(\d+)([.)])\s*([A-Z])/g, '\n$1$2 $3')
                // Add newline before bullet points
                .replace(/([.!?])\s*[-‚Ä¢*]\s*/g, '$1\n- ')
                // Clean up multiple newlines
                .replace(/\n{3,}/g, '\n\n');

            // Split into lines
            let lines = normalized.split('\n');
            let html = '';
            let inList = false;
            let listType = null; // 'bullet' or 'number'

            for (let line of lines) {
                line = line.trim();
                if (!line) {
                    if (inList) {
                        html += '</ul>';
                        inList = false;
                        listType = null;
                    }
                    continue;
                }

                // Check for section headers (ends with : and not too long)
                const headerMatch = line.match(/^([A-Z][^:]{2,60}):?\*?$/);
                if (headerMatch || (line.endsWith(':') && line.length < 60 && !line.startsWith('-'))) {
                    if (inList) {
                        html += '</ul>';
                        inList = false;
                    }
                    const headerText = line.replace(/\*+/g, '').replace(/:$/, '');
                    html += `<h4 class="section-header">${headerText}</h4>`;
                    continue;
                }

                // Check for numbered items (1. or 1) or just number at start)
                const numberedMatch = line.match(/^(\d+)[.)]\s*(.+)/);
                if (numberedMatch) {
                    if (!inList || listType !== 'number') {
                        if (inList) html += '</ul>';
                        html += '<ul class="symptom-list numbered">';
                        inList = true;
                        listType = 'number';
                    }
                    html += `<li><span class="list-number">${numberedMatch[1]}</span>${formatInlineStyles(numberedMatch[2])}</li>`;
                    continue;
                }

                // Check for bullet points (- or * or ‚Ä¢)
                const bulletMatch = line.match(/^[-*‚Ä¢]\s*(.+)/);
                if (bulletMatch) {
                    if (!inList || listType !== 'bullet') {
                        if (inList) html += '</ul>';
                        html += '<ul class="symptom-list">';
                        inList = true;
                        listType = 'bullet';
                    }
                    html += `<li>${formatInlineStyles(bulletMatch[1])}</li>`;
                    continue;
                }

                // Regular text - check if it looks like a list item without bullet
                if (inList && line.length < 100 && !line.includes('.') && !line.endsWith(':')) {
                    // Probably a continuation of the list without bullet
                    html += `<li>${formatInlineStyles(line)}</li>`;
                    continue;
                }

                // Regular paragraph
                if (inList) {
                    html += '</ul>';
                    inList = false;
                    listType = null;
                }
                html += `<p>${formatInlineStyles(line)}</p>`;
            }

            if (inList) html += '</ul>';

            // If no formatting was applied, return nicely wrapped text
            if (!html.includes('<h4') && !html.includes('<ul')) {
                return `<p>${formatInlineStyles(text)}</p>`;
            }

            return html;
        }

        // Format inline styles (bold, italic, quoted terms)
        function formatInlineStyles(text) {
            if (!text) return '';
            // Bold: **text** or *text* at start
            text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/^\*([^*]+)\*$/, '<strong>$1</strong>');
            // Italic markers
            text = text.replace(/_(.+?)_/g, '<em>$1</em>');
            // Quoted terms
            text = text.replace(/"([^"]+)"/g, '<span class="quoted-term">"$1"</span>');
            return text;
        }

        // Ingest memory
        async function ingestMemory() {
            const patientId = document.getElementById('ingestPatientId').value;
            const rawText = document.getElementById('ingestText').value;
            const memoryType = document.getElementById('ingestType').value;
            const source = document.getElementById('ingestSource').value;

            // Get visit metadata
            const visitDate = document.getElementById('ingestDate').value || new Date().toISOString().split('T')[0];
            const visitType = document.getElementById('ingestVisitType').value;
            const clinicianRole = document.getElementById('ingestClinician').value;

            if (!rawText) {
                showToast('Please enter memory content', 'error');
                return;
            }

            const responseDiv = document.getElementById('ingestResponse');
            responseDiv.style.display = 'block';
            responseDiv.innerHTML = '<div class="loading"><div class="spinner"></div>Saving...</div>';

            try {
                const res = await fetch(`${API_BASE}/memory`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        patient_id: patientId,
                        raw_text: rawText,
                        memory_type: memoryType,
                        source,
                        visit: {
                            visit_date: visitDate,
                            visit_type: visitType,
                            clinician_role: clinicianRole
                        },
                        profile: {
                            // Basic logic to attach profile if patient_001
                            full_name: patientId === 'patient_001' ? 'Rahul Verma' : undefined,
                            department: 'Mental Health'
                        }
                    })
                });
                const data = await res.json();

                const action = data.action === 'reinforced' ?
                    'üîÑ Similar memory reinforced!' :
                    '‚úÖ Memory created!';

                responseDiv.innerHTML = `
                    <div class="response-header">
                        <div class="response-meta">
                            <span class="meta-badge success">${action}</span>
                            <span class="meta-badge">üì¶ ${data.chunks_stored} chunk(s)</span>
                        </div>
                    </div>
                    <div class="answer-text">
                        <strong>Action:</strong> ${data.action}<br>
                        <strong>Point ID:</strong> <code>${data.point_ids[0]}</code>
                    </div>
                `;

                showToast(action, 'success');
                document.getElementById('ingestText').value = '';
            } catch (e) {
                responseDiv.innerHTML = `<div class="empty-state">Error: ${e.message}</div>`;
                showToast('Failed to save memory', 'error');
            }
        }

        // Get stats
        async function getStats() {
            const patientId = document.getElementById('summaryPatientId').value;
            const statsGrid = document.getElementById('statsGrid');

            try {
                const res = await fetch(`${API_BASE}/patient/${patientId}/stats`);
                const data = await res.json();

                statsGrid.style.display = 'grid';
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${data.total_memories}</div>
                        <div class="stat-label">Total Memories</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${data.active_memories}</div>
                        <div class="stat-label">Active</div>
                    </div>
                    ${Object.entries(data.by_type || {}).map(([type, count]) => `
                        <div class="stat-card">
                            <div class="stat-value">${count}</div>
                            <div class="stat-label">${type}</div>
                        </div>
                    `).join('')}
                `;
            } catch (e) {
                showToast('Failed to load stats', 'error');
            }
        }

        // Get summary
        async function getSummary() {
            const patientId = document.getElementById('summaryPatientId').value;
            const responseDiv = document.getElementById('summaryResponse');

            responseDiv.style.display = 'block';
            responseDiv.innerHTML = '<div class="loading"><div class="spinner"></div>Generating summary...</div>';

            try {
                const res = await fetch(`${API_BASE}/patient/${patientId}/summary`);
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail || `Server Error ${res.status}`);
                }
                const data = await res.json();

                responseDiv.innerHTML = `
                    <div class="response-header">
                        <div class="response-meta">
                            <span class="meta-badge ${data.has_context ? 'success' : 'warning'}">
                                ${data.has_context ? '‚úì Has Records' : '‚úó No Records'}
                            </span>
                            <span class="meta-badge">üìù ${data.memory_count} memories</span>
                        </div>
                    </div>
                    <div class="answer-text">${(data.summary || '').replace(/\n/g, '<br>').replace(/###/g, '<strong>').replace(/\*\*/g, '')}</div>
                    <div class="disclaimer">${(data.disclaimer || '').replace('---', '').trim()}</div>
                `;
            } catch (e) {
                responseDiv.innerHTML = `<div class="empty-state">Error: ${e.message}</div>`;
            }
        }

        // Demo query
        async function demoQuery(query, resultId) {
            const resultDiv = document.getElementById(resultId);
            resultDiv.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const res = await fetch(`${API_BASE}/search/context`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ patient_id: 'patient_001', query })
                });

                if (!res.ok) {
                    const err = await res.json().catch(() => ({ detail: res.statusText }));
                    throw new Error(err.detail || `Server Error ${res.status}`);
                }

                const data = await res.json();

                // Guard against missing answer_text
                const answerText = data.answer_text || "No response text available.";
                const shortText = answerText.substring(0, 150) + (answerText.length > 150 ? '...' : '');

                resultDiv.innerHTML = `
                    <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-card); border-radius: 0.5rem;">
                        <div class="meta-badge ${data.has_context ? 'success' : 'warning'}" style="margin-bottom: 0.5rem;">
                            ${data.has_context ? '‚úì Evidence Found' : '‚úó No Evidence'}
                        </div>
                        <p style="font-size: 0.85rem; color: var(--text-secondary);">
                            ${shortText}
                        </p>
                    </div>
                `;
            } catch (e) {
                resultDiv.innerHTML = `<span style="color: var(--danger); font-size: 0.9rem;">Error: ${e.message}</span>`;
                console.error("Demo Query Error:", e);
            }
        }

        // Toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Initialize Demo Data and Interactions
        document.addEventListener('DOMContentLoaded', () => {
            // Check if patient_001 is active in local storage or URL
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('patient') === 'patient_001') {
                const card = document.getElementById('patientSummaryCard');
                if (card) card.style.display = 'flex';
            }

            // Add click handler for suggestions to simulation loading patient data
            // We use a timeout to ensure suggestions are rendered if they are dynamic
            setTimeout(() => {
                const suggestions = document.querySelectorAll('.suggestion-tag');
                suggestions.forEach(tag => {
                    tag.addEventListener('click', () => {
                        const text = tag.textContent || "";
                        // If clicking "Rahul Verma", show the summary card
                        if (text.includes('Rahul') || text.includes('001') || text.includes('Anxiety')) {
                            const card = document.getElementById('patientSummaryCard');
                            if (card) card.style.display = 'flex';

                            // Pre-fill inputs with the demo patient ID
                            const pidInputs = ['searchPatientId', 'timelinePatientId', 'ingestPatientId', 'summaryPatientId'];
                            pidInputs.forEach(id => {
                                const el = document.getElementById(id);
                                if (el) el.value = 'patient_001';
                            });

                            // Trigger a relevant query if we are in the search tab
                            if (document.querySelector('.tab.active').getAttribute('data-tab') === 'search') {
                                const query = document.getElementById('searchQuery');
                                if (query && !query.value) query.value = 'Show me recent anxiety symptoms';
                            }
                        }
                    });
                });
            }, 1000);
        });
    </script>
</body>

</html>